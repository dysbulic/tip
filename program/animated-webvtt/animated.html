<html>
  <head>
    <meta charset="UTF-8"/>
    <title>Animated WebVTT Test</title>
    <style>
      html, body {
        margin: 0;
      }
      video {
        width: 100%;
        max-width: 100%;
        max-height: 100vh;
        position: relative;
      }
      .drifting {
        position: absolute;
        inset: 0;
        font-size: max(7vw, 10vh);
        translate: -50% -50%;
        width: min-content;
        height: min-content;
      }
      em-emoji-picker {
        position: absolute;
        display: none;
      }
    </style>
  </head>
  <body>
    <video controls muted autoplay>
      <source src="Big Buck Bunny trailer.webm" type="video/webm"/>
      <track default src="animated.vtt" kind="subtitles" label="Animated"/>
    </video>
    <div id="overlay">
      <span class="drifting" data-start="2000" data-height="80">ğŸ¦€</span>
<!--
      <span class="drifting" data-start="4000" data-height="80">ğŸ¦€</span>
      <span class="drifting" data-start="6000" data-height="80">ğŸ</span>
      <span class="drifting" data-start="8000" data-height="80">ğŸ</span>
      <span class="drifting" data-start="10000" data-height="80">ğŸ¦</span>
      <span class="drifting" data-start="12000" data-height="80">ğŸ¡</span>
      <span class="drifting" data-start="14000" data-height="80">ğŸ¸</span>
      <span class="drifting" data-start="16000" data-height="80">ğŸ¥</span>
      <span class="drifting" data-start="18000" data-height="80">ğŸš¨</span>
      <span class="drifting" data-start="20000" data-height="80">ğŸ¥</span>
      <span class="drifting" data-start="22000" data-height="80">â›º</span>
      <span class="drifting" data-start="24000" data-height="80">ğŸ˜»</span>
      <span class="drifting" data-start="26000" data-height="80">ğŸ§²</span>
      <span class="drifting" data-start="28000" data-height="80">â›”</span>
      <span class="drifting" data-start="30000" data-height="80">ğŸ§¦</span>
-->
    </div>
    <script>
      const video = document.querySelector('video')
      const overlay = document.querySelector('#overlay')
    </script>
    <script>
      class Drifter {
        constructor({ drifter, start, end, initial, height }) {
          drifter ??= (() => {
            const newElem = document.createElement('span')
            newElem.classList.add('drifting')
            overlay.appendChild(newElem)
            return newElem
          })()
          this.elem = drifter

          this.start = start ?? Number(drifter.dataset.start)
          if(isNaN(this.start)) {
            throw new Error(
              '`.drifting` must have a `data-start` time or '
              + '`Drifting` must have `{start}`.'
            )
          }

          this.end = end ?? Number(drifter.dataset.end ?? this.start + 2500)

          drifter.dataset.x ??= 20 + Math.random() * 60
          this.initial = {
            x: initial?.x ?? Number(drifter.dataset.x),
            y: initial?.y ?? Number(drifter.dataset.y ?? 0),
          }

          this.height = height ?? Number(drifter.dataset.height ?? 40)
        }

        set left(x) {
          this.elem.style.left = x
        }

        set top(y) {
          this.elem.style.top = y
        }

        set opacity(o) {
          this.elem.style.opacity = o
        }

        set content(content) {
          this.elem.textContent = content
        }

        toString() {
          return (
            'Drifter('
            + `${this.start}â€“${this.end}, `
            + `<${this.initial.x}, ${this.initial.y}>, `
            + `${this.elem.textContent})`
          )
        }
      }
    </script>
    <script>
      const drifting = document.querySelectorAll('.drifting')
      const drifters = Array.from(drifting).map(
        (drifter) => new Drifter({ drifter })
      )

      const updatePositions = () => {
        const time = video.currentTime * 1000
        drifters.forEach((drifter) => {
          if(time >= drifter.start && time <= drifter.end) {
            const progress = (time - drifter.start) / (drifter.end - drifter.start)
            const x = `${drifter.initial.x + Math.cos(6 * Math.PI * progress)}%`
            drifter.left = x
            const y = `${-drifter.initial.y + 100 - (drifter.height * progress)}%`
            drifter.top = y
            drifter.opacity = 1 - progress
          } else {
            drifter.opacity = 0
          }
        })
        requestAnimationFrame(updatePositions)
      }
      updatePositions()
    </script>
    <script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
    <script>
      let picker
      let initialClick = true
      let initialConfig
      const onClick = (evt) => {
        evt.preventDefault()

        const max = {
          x: document.documentElement.clientWidth,
          y: document.documentElement.clientHeight,
        }
        if(evt.clientY > max.y - (16 * 4)) return

        picker.style.display = 'inline-block'
        const click = { x: evt.clientX, y: evt.clientY }
        const box = {
          w: picker.clientWidth, h: picker.clientHeight,
        }
        console.debug({
          picker, max, click, box,
          dis: picker.style.display,
        })
        picker.style.left = `${evt.clientX - picker.clientWidth / 2}px`
        picker.style.top = (
          `${Math.min(max.y - box.h, Math.max(0, evt.clientY - picker.clientHeight / 2))}px`
        )
        initialConfig = { click, time: video.currentTime * 1000 }
        console.debug('Removing Listener')
        document.removeEventListener('click', onClick)
      }

      onEmojiSelect = (emoji, evt) => {
        console.debug({ evt, initialConfig })
        const drifter = new Drifter({
          start: initialConfig.time,
          initial: {
            x: initialConfig.click.x / video.clientWidth * 100,
            y: 100 - initialConfig.click.y / video.clientHeight * 100,
          }
        })
        drifter.content = emoji.native
        drifters.push(drifter)

        console.debug({ new: drifter.toString() })

        picker.style.display = 'none'
        evt.cancelBubble = true
        console.debug('Adding Listener')
        document.addEventListener('click', onClick)
      }
      const onClickOutside = () => {
        console.debug('click outside', initialClick)
        if(!initialClick) {
          picker.style.display = 'none'
          console.debug('Adding Listener')
          document.addEventListener('click', onClick)
        }
        initialClick = false
      }
      picker = new EmojiMart.Picker({ onEmojiSelect, onClickOutside })
      const sheet = new CSSStyleSheet()
      sheet.replaceSync('#root { height: max(50vh, 35ch) }')
      picker.shadowRoot.adoptedStyleSheets.push(sheet)
      document.body.appendChild(picker)
      console.debug('Adding Listener')
      document.addEventListener('click', onClick)
    </script>
  </body>